# СПП, лабораторная работа №4

Веб-приложение с использованием веб-сокетов (socket.io)

# Использованные технологии:

  - node.js + socket.io на сервере;
  - Bootstrap (v4.4.1), jQuery + socket.io-client на клиенте;
  - БД MySQL.

# Функционал:
- просмотр списка гитар в виде таблицы (список хранится в БД MySQL);
- возможность фильтрации, сортировки списка в таблице, пагинация списка (с помощью библиотеки MDB);
- удаление/добавление информации о гитаре в список (БД MySQL).
- добавление изображения к элементу списка, отображение его в списке (в случае отсутствия используется картинка-заглушка).
- регистрация в веб-приложении (позволяет удалять существующие записи);

1. Клиентская часть
    1. Сайт состоит из единственного HTML-файла index.html и файла со скриптами main.js. 
    2. SPA-стиль обеспечивается за счёт использования блочных элементов <div class="page">, в которые обёрнуты все страницы сайта. Пример:
         ```html
         <!---Страница добавления товара-->
         <div class="page" id=addingPage>
             <form name="input">
             ...
             </form>
         </div>
         <!--Страница входа в аккаунт-->
         <div class="page" id=loginPage>
         ...
         </div>
         ```
        Перемещение между страницами осуществляется за счёт изменения хеш-адреса. При его изменении вызывается функция
        ```js
        window.onhashchange = function () {
             render(window.location.hash);
        } 
        ```
        Функция render(hashkey) сперва скрывает все div'ы, а затем, исходя из значения хеша, изменяет свойство display у требуемого div
    3. Таблица реализована с помощью библиотек Material Design for Bootstrap. Обновление таблицы происходит после успешного выполнения запроса на сервер с целью удаления/добавления нового элемента в список при помощи метода append:
         ```js
         $("table tbody").append(row(guitar));
         ```
    4. Диалог выбора файла реализован с помощью стандартных средств JS:
         ```js
         <input id="file_input" name="image" type="file" onchange="uploadFile(this)">
        ```
        Отправка файла осуществляется за счёт выполнения метода uploadFile(input), в котором вызывается метод emit() объекта socket с параметрами в виде, собственно, файла и его имени с расширением:
        ```js
        async function uploadFile(input) {
            //получение имени файла filename
            imageFilename = filename;
            let file = input.files[0];
            socket.emit('add_image', file, filename);
        }
        ```
    5. Взаимодействие с сервером осуществляется с помощью объекта *socket* и его методов *on()* (для прослушки) и *emit()* (для отправки запросов на сервер), причём каждое сообщение имеет свой определённый тип ('delete_guitar', 'login' и т.п.). К примеру, так происходит обмен сообщениями между сервером и клиентом при добавлении нового товара:
        ```js
        function addGuitar(model, amount, id, imageSrc) {
            let data =[model, amount, id, imageSrc];
            socket.emit('add_guitar',data);
        }    
        ```
        Здесь клиент отсылкает серверу сообщение типа 'add_guitar' с параметром **data**, содержащим массив с данными. На стороне сервера данное событие прослушивается методом ***socket.on**('add_guitar', function(data){})*:
        ```js
        socket.on('add_guitar', function (data) {
        ////получение значений из массива
        let sql = "INSERT INTO warehouse VALUES (?,?,?,?)";
        connection.query(sql,data2, function (err, results) {
            if (!err)
                socket.emit('guitar_added', obj)
            });
        });
        ```
        Как можно заметить, при успешном добавлении записи в БД сервер посылает сообщение **'guitar_added'**, которое отлавливается клиентом:
        ```js
        socket.on('guitar_added', data =>{
            $("#adding_form").find("input").val('');
            $("table tbody").append(row(data));
        });
        ```
2. Серверная часть
    1. Взаимодействие с клиентом подробно описано в п.5 раздела "Клиентская часть"
    2. Для взаимодействия с БД MySQL используется библиотека mysql2. Данные с сервера на клиент посылаются в формате JSON. После установки соединения с клиентом с помощью сокета на клиент отправляются данные, полученные из БД:
        ```js
        connection.query("SELECT * FROM warehouse;",function(err, results, fields) {
            let guitars = JSON.stringify(results);
            let content=JSON.parse(guitars);
            socket.emit('data', content);
        });
        ```
    3. Аутентификация осуществляется по следующему принципу:
        1. В БД выполняется запрос для получения пользователя с заданным логином. 
        2. Модуль bcrypt сравнивает полученный от клиента пароль с хешем, хранящимся в БД. В случае совпадения выполняются последующие пункты, иначе отправляется сообщение типа "login_error"
        3. Создаётся JWT на основе логина и секретного ключа с временем жизни в 1 час
        4. Токен отсылкается на клиент с сообщением типа **"logged_in"**, где происходит его сохранение
    4. При попытке выполнить удаление объекта из списка на клиенте, на сервере первоначально будет проведена проверка пользовательского токена, полученного из cookie:
         ```js
         socket.on('delete_guitar', function(guitar_id, token){
        if ((token !== null) && verifyToken(token)){
            //запрос в БД для удаления
            //отправка сообщения в случае успешного удаления записи
            socket.emit('guitar_deleted', guitar_id);
        }
        else
            ///сообщение о запрете доступа
            socket.emit('access_denied');
        });
        ```
        Для верификации используется стандартная функция библиотеки jsonwebtoken.
    5. При нажатии на кнопку "Выйти" на клиенте происходит обнуление cookie c помощью установки прошедшей даты.
  
  # Демонстрация фиксов
  Ссылка на видео:
  https://youtu.be/YWO6o7QU4qA 
  
  Пофикшено:
  -broadcast-рассылка сообщений всем подключённым соединениям;
  -перенаправление на главную после добавления товара;
  -проверка валидности токена;
